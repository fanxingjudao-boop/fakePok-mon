<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            overflow-x: hidden;
            touch-action: pan-y;
            font-family: 'Arial', 'Hiragino Sans', sans-serif;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿
        const MONSTER_DATABASE = {
          // ç‚ã‚¿ã‚¤ãƒ—
          1: { id: 1, name: 'ãƒ’ãƒˆã‚«', type: 'fire', baseHP: 28, baseAtk: 45, baseDef: 35, evolvesTo: 2, evolveLevel: 12, sprite: 'ğŸ¦' },
          2: { id: 2, name: 'ãƒ’ã‚«ãƒªãƒ¥ã‚¦', type: 'fire', baseHP: 42, baseAtk: 58, baseDef: 48, evolvesTo: 3, evolveLevel: 28, sprite: 'ğŸ²' },
          3: { id: 3, name: 'ãƒªã‚¶ãƒ¼ãƒ‰', type: 'fire', baseHP: 58, baseAtk: 78, baseDef: 62, evolvesTo: null, evolveLevel: null, sprite: 'ğŸ”¥' },
          4: { id: 4, name: 'ãƒ•ãƒ¬ã‚¤ãƒ ', type: 'fire', baseHP: 30, baseAtk: 50, baseDef: 30, evolvesTo: 5, evolveLevel: 15, sprite: 'ğŸŒ‹' },
          5: { id: 5, name: 'ãƒã‚°ãƒãƒ‰ãƒ³', type: 'fire', baseHP: 55, baseAtk: 85, baseDef: 55, evolvesTo: null, evolveLevel: null, sprite: 'ğŸŒ¶ï¸' },
          
          // æ°´ã‚¿ã‚¤ãƒ—
          6: { id: 6, name: 'ãƒŸã‚ºã‚¬ãƒ¡', type: 'water', baseHP: 32, baseAtk: 40, baseDef: 50, evolvesTo: 7, evolveLevel: 12, sprite: 'ğŸ¢' },
          7: { id: 7, name: 'ã‚«ãƒ¡ãƒƒã‚¯ã‚¹', type: 'water', baseHP: 45, baseAtk: 55, baseDef: 65, evolvesTo: 8, evolveLevel: 28, sprite: 'ğŸŒŠ' },
          8: { id: 8, name: 'ã‚«ãƒ¡ã‚­ãƒ³ã‚°', type: 'water', baseHP: 62, baseAtk: 70, baseDef: 82, evolvesTo: null, evolveLevel: null, sprite: 'ğŸ’' },
          9: { id: 9, name: 'ã‚¢ã‚¯ã‚¢ãƒ³', type: 'water', baseHP: 35, baseAtk: 48, baseDef: 45, evolvesTo: 10, evolveLevel: 15, sprite: 'ğŸŸ' },
          10: { id: 10, name: 'ãƒãƒ—ãƒãƒ¥ãƒ¼ãƒ³', type: 'water', baseHP: 60, baseAtk: 75, baseDef: 70, evolvesTo: null, evolveLevel: null, sprite: 'ğŸ”±' },
          
          // è‰ã‚¿ã‚¤ãƒ—
          11: { id: 11, name: 'ã‚¯ã‚µãƒ€ãƒ', type: 'grass', baseHP: 33, baseAtk: 42, baseDef: 40, evolvesTo: 12, evolveLevel: 12, sprite: 'ğŸŒ±' },
          12: { id: 12, name: 'ã‚¯ã‚µãƒãƒŠ', type: 'grass', baseHP: 46, baseAtk: 56, baseDef: 54, evolvesTo: 13, evolveLevel: 28, sprite: 'ğŸŒ»' },
          13: { id: 13, name: 'ã‚¯ã‚µã‚ªãƒ¼', type: 'grass', baseHP: 60, baseAtk: 72, baseDef: 68, evolvesTo: null, evolveLevel: null, sprite: 'ğŸŒ³' },
          14: { id: 14, name: 'ãƒãƒƒãƒ‘ãƒ¼', type: 'grass', baseHP: 36, baseAtk: 46, baseDef: 42, evolvesTo: 15, evolveLevel: 15, sprite: 'ğŸƒ' },
          15: { id: 15, name: 'ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ', type: 'grass', baseHP: 58, baseAtk: 80, baseDef: 65, evolvesTo: null, evolveLevel: null, sprite: 'ğŸŒ²' }
        };

        const MOVES_DATABASE = {
          fire: [
            { name: 'ã²ã£ã‹ã', power: 30, type: 'normal', level: 1, effect: null },
            { name: 'ã²ã®ã“', power: 35, type: 'fire', level: 1, effect: null },
            { name: 'ã‹ãˆã‚“ã»ã†ã—ã‚ƒ', power: 75, type: 'fire', level: 18, effect: null },
            { name: 'ã ã„ã‚‚ã‚“ã˜', power: 95, type: 'fire', level: 25, effect: null }
          ],
          water: [
            { name: 'ãŸã„ã‚ãŸã‚Š', power: 30, type: 'normal', level: 1, effect: null },
            { name: 'ã¿ãšã§ã£ã½ã†', power: 35, type: 'water', level: 1, effect: null },
            { name: 'ãªã¿ã®ã‚Š', power: 75, type: 'water', level: 18, effect: null },
            { name: 'ãƒã‚¤ãƒ‰ãƒ­ãƒãƒ³ãƒ—', power: 95, type: 'water', level: 25, effect: null }
          ],
          grass: [
            { name: 'ã¤ã‚‹ã®ãƒ ãƒ', power: 35, type: 'grass', level: 1, effect: null },
            { name: 'ã¯ã£ã±ã‚«ãƒƒã‚¿ãƒ¼', power: 45, type: 'grass', level: 1, effect: null },
            { name: 'ã©ãã®ã“ãª', power: 0, type: 'grass', level: 12, effect: 'poison' },
            { name: 'ã‚½ãƒ¼ãƒ©ãƒ¼ãƒ“ãƒ¼ãƒ ', power: 100, type: 'grass', level: 25, effect: null }
          ]
        };

        const TYPE_CHART = {
          fire: { grass: 2, water: 0.5, fire: 1, normal: 1 },
          water: { fire: 2, grass: 0.5, water: 1, normal: 1 },
          grass: { water: 2, fire: 0.5, grass: 1, normal: 1 },
          normal: { fire: 1, water: 1, grass: 1, normal: 1 }
        };

        // ã‚¢ã‚¤ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
        const ITEMS = {
          potion: { name: 'ã‚­ã‚ºãã™ã‚Š', price: 200, heal: 20, description: 'HPã‚’20å›å¾©' },
          superPotion: { name: 'ã„ã„ã‚­ã‚ºãã™ã‚Š', price: 700, heal: 50, description: 'HPã‚’50å›å¾©' },
          antidote: { name: 'ã©ãã‘ã—', price: 100, cure: 'poison', description: 'æ¯’ã‚’æ²»ã™' },
          awakening: { name: 'ã­ã‚€ã‘ã–ã¾ã—', price: 200, cure: 'sleep', description: 'çœ ã‚Šã‚’æ²»ã™' },
          paralyzHeal: { name: 'ã¾ã²ãªãŠã—', price: 200, cure: 'paralyze', description: 'éº»ç—ºã‚’æ²»ã™' },
          monsterBall: { name: 'ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãƒœãƒ¼ãƒ«', price: 200, description: 'æ•ç²ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆæœªå®Ÿè£…ï¼‰' }
        };

        // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é€²è¡Œãƒ‡ãƒ¼ã‚¿
        const STORY_DATA = {
          towns: [
            { id: 'start', name: 'ã¯ã˜ã¾ã‚Šã®ç”º', shop: true, heal: true },
            { id: 'forest', name: 'ã‚‚ã‚Šã®ç”º', shop: true, heal: true },
            { id: 'mountain', name: 'ã‚„ã¾ã®ç”º', shop: true, heal: true },
            { id: 'final', name: 'ã•ã„ã”ã®ç”º', shop: true, heal: true }
          ],
          routes: [
            { id: 'route1', name: '1ã°ã‚“ã©ã†ã‚', from: 'start', to: 'forest', enemies: [1, 6, 11], minLevel: 3, maxLevel: 6 },
            { id: 'route2', name: '2ã°ã‚“ã©ã†ã‚', from: 'forest', to: 'mountain', enemies: [2, 7, 12], minLevel: 10, maxLevel: 15 },
            { id: 'route3', name: '3ã°ã‚“ã©ã†ã‚', from: 'mountain', to: 'final', enemies: [3, 8, 13], minLevel: 20, maxLevel: 25 }
          ],
          rivals: [
            { id: 'rival1', name: 'ãƒ©ã‚¤ãƒãƒ« ã‚¿ã‚¯ãƒŸ', location: 'forest', monster: 2, level: 12, reward: 500, sprite: 'ğŸ‘¦' },
            { id: 'rival2', name: 'ãƒ©ã‚¤ãƒãƒ« ã‚¢ã‚«ãƒ', location: 'mountain', monster: 7, level: 20, reward: 1000, sprite: 'ğŸ‘§' },
            { id: 'rival3', name: 'ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³', location: 'final', monster: 3, level: 35, reward: 5000, sprite: 'ğŸ‘‘' }
          ]
        };

        const MonsterRPG = () => {
          const [screen, setScreen] = useState('title');
          const [currentLocation, setCurrentLocation] = useState('start');
          const [playerMonster, setPlayerMonster] = useState(null);
          const [enemyMonster, setEnemyMonster] = useState(null);
          const [battleLog, setBattleLog] = useState([]);
          const [isPlayerTurn, setIsPlayerTurn] = useState(true);
          const [money, setMoney] = useState(3000);
          const [inventory, setInventory] = useState({});
          const [defeatedRivals, setDefeatedRivals] = useState([]);
          const [isAnimating, setIsAnimating] = useState(false);
          const [damageFlash, setDamageFlash] = useState(null);
          const [showEvolution, setShowEvolution] = useState(false);
          const [evolutionData, setEvolutionData] = useState(null);
          const [battleType, setBattleType] = useState('wild'); // wild, rival, champion
          const [currentRival, setCurrentRival] = useState(null);

          useEffect(() => {
            const saved = localStorage.getItem('monsterRPGSaveV2');
            if (saved) {
              const data = JSON.parse(saved);
              if (data.playerMonster) {
                setPlayerMonster(data.playerMonster);
                setMoney(data.money || 3000);
                setInventory(data.inventory || {});
                setCurrentLocation(data.location || 'start');
                setDefeatedRivals(data.defeatedRivals || []);
                setScreen('town');
              }
            }
          }, []);

          const saveGame = (monster, loc, mon, inv, rivals) => {
            localStorage.setItem('monsterRPGSaveV2', JSON.stringify({
              playerMonster: monster,
              money: mon,
              inventory: inv,
              location: loc,
              defeatedRivals: rivals
            }));
          };

          const createMonster = (monsterId, level = 1) => {
            const baseData = MONSTER_DATABASE[monsterId];
            const hpBonus = (level - 1) * 3;
            const atkBonus = (level - 1) * 4;
            const defBonus = (level - 1) * 2;
            
            const maxHP = baseData.baseHP + hpBonus;
            const moves = MOVES_DATABASE[baseData.type].filter(m => m.level <= level);
            
            return {
              ...baseData,
              level,
              exp: 0,
              expToNext: level * 80,
              currentHP: maxHP,
              maxHP,
              attack: baseData.baseAtk + atkBonus,
              defense: baseData.baseDef + defBonus,
              moves: moves.slice(-4),
              status: null // poison, paralyze, sleep
            };
          };

          const selectStarter = (monsterId) => {
            const monster = createMonster(monsterId, 5);
            setPlayerMonster(monster);
            setCurrentLocation('start');
            saveGame(monster, 'start', 3000, {}, []);
            setScreen('story-intro');
          };

          const startWildBattle = (routeId) => {
            const route = STORY_DATA.routes.find(r => r.id === routeId);
            const enemyId = route.enemies[Math.floor(Math.random() * route.enemies.length)];
            const enemyLevel = Math.floor(Math.random() * (route.maxLevel - route.minLevel + 1)) + route.minLevel;
            
            const enemy = createMonster(enemyId, enemyLevel);
            setEnemyMonster(enemy);
            setBattleType('wild');
            setBattleLog([`é‡ç”Ÿã®${enemy.name}ãŒç¾ã‚ŒãŸï¼`]);
            setIsPlayerTurn(true);
            setScreen('battle');
          };

          const startRivalBattle = (rivalId) => {
            const rival = STORY_DATA.rivals.find(r => r.id === rivalId);
            const enemy = createMonster(rival.monster, rival.level);
            setEnemyMonster(enemy);
            setBattleType(rivalId === 'rival3' ? 'champion' : 'rival');
            setCurrentRival(rival);
            setBattleLog([`${rival.name}ãŒå‹è² ã‚’ä»•æ›ã‘ã¦ããŸï¼`]);
            setIsPlayerTurn(true);
            setScreen('battle');
          };

          const calculateDamage = (attacker, defender, move) => {
            if (move.power === 0) return { damage: 0, effectiveness: 1 }; // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æŠ€
            
            const effectiveness = TYPE_CHART[move.type][defender.type];
            const baseDamage = ((attacker.attack * move.power / defender.defense) / 5) * effectiveness;
            const randomFactor = 0.85 + Math.random() * 0.15;
            const damage = Math.max(1, Math.floor(baseDamage * randomFactor));
            return { damage, effectiveness };
          };

          const applyStatus = (target, effect) => {
            if (effect === 'poison' && Math.random() < 0.3) {
              return { ...target, status: 'poison' };
            } else if (effect === 'paralyze' && Math.random() < 0.25) {
              return { ...target, status: 'paralyze' };
            } else if (effect === 'sleep' && Math.random() < 0.2) {
              return { ...target, status: 'sleep' };
            }
            return target;
          };

          const checkStatus = (monster) => {
            if (monster.status === 'poison') {
              const damage = Math.floor(monster.maxHP / 8);
              return { damage, canMove: true, message: `${monster.name}ã¯æ¯’ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼` };
            } else if (monster.status === 'paralyze') {
              const canMove = Math.random() > 0.25;
              return { damage: 0, canMove, message: canMove ? '' : `${monster.name}ã¯ä½“ãŒç—ºã‚Œã¦å‹•ã‘ãªã„ï¼` };
            } else if (monster.status === 'sleep') {
              const wakeUp = Math.random() > 0.5;
              if (wakeUp) {
                return { damage: 0, canMove: true, message: `${monster.name}ã¯ç›®ã‚’è¦šã¾ã—ãŸï¼`, removeStatus: true };
              }
              return { damage: 0, canMove: false, message: `${monster.name}ã¯çœ ã£ã¦ã„ã‚‹...` };
            }
            return { damage: 0, canMove: true, message: '' };
          };

          const playerAttack = (move) => {
            if (isAnimating || !isPlayerTurn) return;
            
            setIsAnimating(true);
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç•°å¸¸ãƒã‚§ãƒƒã‚¯
            const statusCheck = checkStatus(playerMonster);
            if (statusCheck.message) {
              setBattleLog(prev => [...prev, statusCheck.message]);
            }
            
            if (statusCheck.removeStatus) {
              setPlayerMonster(prev => ({ ...prev, status: null }));
            }
            
            if (!statusCheck.canMove) {
              setTimeout(() => {
                if (statusCheck.damage > 0) {
                  const newHP = Math.max(0, playerMonster.currentHP - statusCheck.damage);
                  setPlayerMonster(prev => ({ ...prev, currentHP: newHP }));
                }
                setIsPlayerTurn(false);
                setTimeout(() => enemyAttack(), 1500);
              }, 1500);
              return;
            }
            
            const { damage, effectiveness } = calculateDamage(playerMonster, enemyMonster, move);
            
            let newEnemy = { ...enemyMonster, currentHP: Math.max(0, enemyMonster.currentHP - damage) };
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç•°å¸¸åŠ¹æœ
            if (move.effect) {
              newEnemy = applyStatus(newEnemy, move.effect);
            }
            
            setEnemyMonster(newEnemy);
            setDamageFlash('enemy');
            
            let messages = [`${playerMonster.name}ã®${move.name}ï¼`];
            if (damage > 0) messages.push(`${damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
            if (effectiveness === 2) messages.push('åŠ¹æœã¯æŠœç¾¤ã ï¼');
            else if (effectiveness === 0.5) messages.push('åŠ¹æœã¯ã„ã¾ã²ã¨ã¤ã ...');
            if (move.effect && newEnemy.status === move.effect) {
              const statusName = move.effect === 'poison' ? 'æ¯’' : move.effect === 'paralyze' ? 'éº»ç—º' : 'çœ ã‚Š';
              messages.push(`${enemyMonster.name}ã¯${statusName}çŠ¶æ…‹ã«ãªã£ãŸï¼`);
            }
            
            setBattleLog(prev => [...prev, ...messages]);
            
            setTimeout(() => {
              setDamageFlash(null);
              
              // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç•°å¸¸ã®ãƒ€ãƒ¡ãƒ¼ã‚¸
              if (statusCheck.damage > 0) {
                const newHP = Math.max(0, playerMonster.currentHP - statusCheck.damage);
                setPlayerMonster(prev => ({ ...prev, currentHP: newHP }));
              }
              
              if (newEnemy.currentHP === 0) {
                handleVictory();
              } else {
                setIsPlayerTurn(false);
                setTimeout(() => enemyAttack(), 1500);
              }
            }, 800);
          };

          const enemyAttack = () => {
            // æ•µã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç•°å¸¸ãƒã‚§ãƒƒã‚¯
            const statusCheck = checkStatus(enemyMonster);
            if (statusCheck.message) {
              setBattleLog(prev => [...prev, statusCheck.message]);
            }
            
            if (statusCheck.removeStatus) {
              setEnemyMonster(prev => ({ ...prev, status: null }));
            }
            
            if (!statusCheck.canMove) {
              setTimeout(() => {
                if (statusCheck.damage > 0) {
                  const newHP = Math.max(0, enemyMonster.currentHP - statusCheck.damage);
                  setEnemyMonster(prev => ({ ...prev, currentHP: newHP }));
                  
                  if (newHP === 0) {
                    handleVictory();
                    return;
                  }
                }
                setIsPlayerTurn(true);
                setIsAnimating(false);
              }, 1500);
              return;
            }
            
            const move = enemyMonster.moves[Math.floor(Math.random() * enemyMonster.moves.length)];
            const { damage } = calculateDamage(enemyMonster, playerMonster, move);
            
            const newPlayerHP = Math.max(0, playerMonster.currentHP - damage);
            setPlayerMonster(prev => ({ ...prev, currentHP: newPlayerHP }));
            setDamageFlash('player');
            
            setBattleLog(prev => [...prev, `${enemyMonster.name}ã®${move.name}ï¼`, `${damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼`]);
            
            setTimeout(() => {
              setDamageFlash(null);
              
              // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç•°å¸¸ãƒ€ãƒ¡ãƒ¼ã‚¸
              if (statusCheck.damage > 0) {
                const newHP = Math.max(0, enemyMonster.currentHP - statusCheck.damage);
                setEnemyMonster(prev => ({ ...prev, currentHP: newHP }));
                
                if (newHP === 0) {
                  handleVictory();
                  return;
                }
              }
              
              if (newPlayerHP === 0) {
                setBattleLog(prev => [...prev, `${playerMonster.name}ã¯å€’ã‚ŒãŸ...`]);
                setTimeout(() => {
                  setScreen('gameover');
                  setIsAnimating(false);
                }, 2000);
              } else {
                setIsPlayerTurn(true);
                setIsAnimating(false);
              }
            }, 800);
          };

          const handleVictory = () => {
            setTimeout(() => {
              let reward = enemyMonster.level * 50;
              
              if (battleType === 'rival' || battleType === 'champion') {
                reward = currentRival.reward;
                setBattleLog(prev => [...prev, `${enemyMonster.name}ã‚’å€’ã—ãŸï¼`, `${reward}å††ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼`]);
                setDefeatedRivals(prev => {
                  const updated = [...prev, currentRival.id];
                  
                  if (battleType === 'champion') {
                    // ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
                    setTimeout(() => {
                      setScreen('ending');
                    }, 3000);
                    return updated;
                  } else {
                    const newMoney = money + reward;
                    setMoney(newMoney);
                    saveGame(playerMonster, currentLocation, newMoney, inventory, updated);
                    setTimeout(() => {
                      setScreen('town');
                      setIsAnimating(false);
                    }, 3000);
                    return updated;
                  }
                });
              } else {
                const expGained = enemyMonster.level * 40;
                const newMoney = money + reward;
                setMoney(newMoney);
                
                const newExp = playerMonster.exp + expGained;
                setBattleLog(prev => [...prev, `${enemyMonster.name}ã‚’å€’ã—ãŸï¼`, `${expGained}ã®çµŒé¨“å€¤ã‚’å¾—ãŸï¼`, `${reward}å††ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼`]);
                
                if (newExp >= playerMonster.expToNext) {
                  levelUp(expGained, newMoney);
                } else {
                  const updatedMonster = { ...playerMonster, exp: newExp, status: null };
                  setPlayerMonster(updatedMonster);
                  saveGame(updatedMonster, currentLocation, newMoney, inventory, defeatedRivals);
                  
                  setTimeout(() => {
                    setScreen('town');
                    setIsAnimating(false);
                  }, 3000);
                }
              }
            }, 1000);
          };

          const levelUp = (expGained, currentMoney) => {
            const newLevel = playerMonster.level + 1;
            const newMaxHP = playerMonster.maxHP + 3;
            const newAttack = playerMonster.attack + 4;
            const newDefense = playerMonster.defense + 2;
            const newExpToNext = newLevel * 80;
            const remainingExp = (playerMonster.exp + expGained) - playerMonster.expToNext;
            
            const newMoves = MOVES_DATABASE[playerMonster.type].filter(m => m.level <= newLevel).slice(-4);
            
            let updatedMonster = {
              ...playerMonster,
              level: newLevel,
              exp: remainingExp,
              expToNext: newExpToNext,
              currentHP: playerMonster.currentHP + 3,
              maxHP: newMaxHP,
              attack: newAttack,
              defense: newDefense,
              moves: newMoves,
              status: null
            };
            
            setBattleLog(prev => [...prev, `${playerMonster.name}ã¯ãƒ¬ãƒ™ãƒ«${newLevel}ã«ãªã£ãŸï¼`]);
            
            if (playerMonster.evolvesTo && newLevel >= playerMonster.evolveLevel) {
              setTimeout(() => {
                evolveMonster(updatedMonster, currentMoney);
              }, 2000);
            } else {
              setPlayerMonster(updatedMonster);
              saveGame(updatedMonster, currentLocation, currentMoney, inventory, defeatedRivals);
              
              setTimeout(() => {
                setScreen('town');
                setIsAnimating(false);
              }, 3000);
            }
          };

          const evolveMonster = (monster, currentMoney) => {
            const evolvedData = MONSTER_DATABASE[monster.evolvesTo];
            setEvolutionData({ from: monster.name, to: evolvedData.name });
            setShowEvolution(true);
            
            setTimeout(() => {
              const hpBonus = (monster.level - 1) * 3;
              const atkBonus = (monster.level - 1) * 4;
              const defBonus = (monster.level - 1) * 2;
              
              const hpIncrease = (evolvedData.baseHP - MONSTER_DATABASE[monster.id].baseHP);
              
              const evolvedMonster = {
                ...monster,
                ...evolvedData,
                maxHP: evolvedData.baseHP + hpBonus,
                currentHP: monster.currentHP + hpIncrease,
                attack: evolvedData.baseAtk + atkBonus,
                defense: evolvedData.baseDef + defBonus
              };
              
              setPlayerMonster(evolvedMonster);
              saveGame(evolvedMonster, currentLocation, currentMoney, inventory, defeatedRivals);
              
              setTimeout(() => {
                setShowEvolution(false);
                setScreen('town');
                setIsAnimating(false);
              }, 3000);
            }, 2000);
          };

          const useItem = (itemKey) => {
            const item = ITEMS[itemKey];
            if (!inventory[itemKey] || inventory[itemKey] <= 0) return;
            
            let updated = { ...playerMonster };
            let message = '';
            
            if (item.heal) {
              const newHP = Math.min(updated.maxHP, updated.currentHP + item.heal);
              updated.currentHP = newHP;
              message = `${updated.name}ã®HPãŒ${item.heal}å›å¾©ã—ãŸï¼`;
            } else if (item.cure) {
              if (updated.status === item.cure) {
                updated.status = null;
                const statusName = item.cure === 'poison' ? 'æ¯’' : item.cure === 'paralyze' ? 'éº»ç—º' : 'çœ ã‚Š';
                message = `${updated.name}ã®${statusName}ãŒæ²»ã£ãŸï¼`;
              } else {
                message = 'åŠ¹æœãŒãªã‹ã£ãŸ...';
              }
            }
            
            setPlayerMonster(updated);
            const newInventory = { ...inventory, [itemKey]: inventory[itemKey] - 1 };
            setInventory(newInventory);
            saveGame(updated, currentLocation, money, newInventory, defeatedRivals);
            
            if (screen === 'battle' && message) {
              setBattleLog(prev => [...prev, message]);
              setIsPlayerTurn(false);
              setTimeout(() => enemyAttack(), 1500);
            }
          };

          const runAway = () => {
            if (battleType !== 'wild') {
              setBattleLog(prev => [...prev, 'ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼æˆ¦ã§ã¯é€ƒã’ã‚‰ã‚Œãªã„ï¼']);
              return;
            }
            
            if (Math.random() < 0.5) {
              setBattleLog(prev => [...prev, 'ã†ã¾ãé€ƒã’åˆ‡ã‚ŒãŸï¼']);
              setTimeout(() => {
                setScreen('town');
                setIsAnimating(false);
              }, 1500);
            } else {
              setBattleLog(prev => [...prev, 'é€ƒã’ã‚‰ã‚Œãªã‹ã£ãŸï¼']);
              setIsPlayerTurn(false);
              setTimeout(() => enemyAttack(), 1500);
            }
          };

          const buyItem = (itemKey) => {
            const item = ITEMS[itemKey];
            if (money < item.price) return;
            
            const newMoney = money - item.price;
            const newInventory = { ...inventory, [itemKey]: (inventory[itemKey] || 0) + 1 };
            setMoney(newMoney);
            setInventory(newInventory);
            saveGame(playerMonster, currentLocation, newMoney, newInventory, defeatedRivals);
          };

          const healAtCenter = () => {
            const healed = { ...playerMonster, currentHP: playerMonster.maxHP, status: null };
            setPlayerMonster(healed);
            saveGame(healed, currentLocation, money, inventory, defeatedRivals);
          };

          const moveToLocation = (newLocation) => {
            setCurrentLocation(newLocation);
            saveGame(playerMonster, newLocation, money, inventory, defeatedRivals);
            setScreen('town');
          };

          const resetGame = () => {
            localStorage.removeItem('monsterRPGSaveV2');
            setPlayerMonster(null);
            setMoney(3000);
            setInventory({});
            setCurrentLocation('start');
            setDefeatedRivals([]);
            setScreen('title');
          };

          const getHPBarColor = (current, max) => {
            const percentage = (current / max) * 100;
            if (percentage > 50) return '#48D248';
            if (percentage > 25) return '#F8D030';
            return '#F85030';
          };

          const getTypeColor = (type) => {
            const colors = {
              fire: '#F08030',
              water: '#6890F0',
              grass: '#78C850',
              normal: '#A8A878'
            };
            return colors[type];
          };

          const getStatusIcon = (status) => {
            if (status === 'poison') return 'ğŸŸ£';
            if (status === 'paralyze') return 'âš¡';
            if (status === 'sleep') return 'ğŸ’¤';
            return '';
          };

          // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢
          if (screen === 'title') {
            return (
              <div style={{ 
                minHeight: '100vh', 
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontFamily: 'Arial, sans-serif',
                padding: '20px'
              }}>
                <div className="fade-in" style={{ 
                  background: 'white', 
                  border: '4px solid #333',
                  borderRadius: '20px',
                  padding: '50px 40px',
                  textAlign: 'center',
                  maxWidth: '500px',
                  boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
                }}>
                  <h1 style={{ fontSize: '42px', margin: '0 0 10px 0', color: '#667eea', fontWeight: 'bold' }}>
                    âš¡ ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ âš¡<br/>ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼
                  </h1>
                  <p style={{ fontSize: '16px', marginBottom: '40px', color: '#666' }}>
                    å£®å¤§ãªå†’é™ºãŒä»Šã€å§‹ã¾ã‚‹
                  </p>
                  <button
                    onClick={() => setScreen('select')}
                    style={{
                      background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                      color: 'white',
                      border: 'none',
                      padding: '18px 50px',
                      fontSize: '20px',
                      borderRadius: '30px',
                      cursor: 'pointer',
                      fontWeight: 'bold',
                      boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)',
                      transition: 'all 0.3s'
                    }}
                    onMouseOver={(e) => {
                      e.target.style.transform = 'translateY(-2px)';
                      e.target.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.6)';
                    }}
                    onMouseOut={(e) => {
                      e.target.style.transform = 'translateY(0)';
                      e.target.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.4)';
                    }}
                  >
                    ã¼ã†ã‘ã‚“ã‚’ ã¯ã˜ã‚ã‚‹
                  </button>
                </div>
              </div>
            );
          }

          // ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼é¸æŠç”»é¢
          if (screen === 'select') {
            return (
              <div style={{ 
                minHeight: '100vh', 
                background: 'linear-gradient(to bottom, #87CEEB, #E8F4F8)',
                padding: '20px',
                fontFamily: 'Arial, sans-serif'
              }}>
                <div style={{ maxWidth: '900px', margin: '0 auto' }}>
                  <h2 style={{ textAlign: 'center', fontSize: '28px', marginBottom: '15px', color: '#333' }}>
                    æœ€åˆã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’é¸ã¼ã†ï¼
                  </h2>
                  <p style={{ textAlign: 'center', fontSize: '16px', marginBottom: '35px', color: '#666' }}>
                    ãã¿ã¨ä¸€ç·’ã«å†’é™ºã™ã‚‹ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’é¸ã‚“ã§ã­
                  </p>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(160px, 1fr))', gap: '20px' }}>
                    {[1, 4, 6, 9, 11, 14].map(id => {
                      const monster = MONSTER_DATABASE[id];
                      return (
                        <div
                          key={id}
                          onClick={() => selectStarter(id)}
                          className="fade-in"
                          style={{
                            background: 'white',
                            border: '3px solid #333',
                            borderRadius: '15px',
                            padding: '20px 15px',
                            cursor: 'pointer',
                            textAlign: 'center',
                            transition: 'all 0.3s',
                            boxShadow: '0 4px 10px rgba(0,0,0,0.1)'
                          }}
                          onMouseOver={(e) => {
                            e.currentTarget.style.transform = 'translateY(-8px)';
                            e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.2)';
                          }}
                          onMouseOut={(e) => {
                            e.currentTarget.style.transform = 'translateY(0)';
                            e.currentTarget.style.boxShadow = '0 4px 10px rgba(0,0,0,0.1)';
                          }}
                        >
                          <div style={{
                            width: '90px',
                            height: '90px',
                            margin: '0 auto 12px',
                            background: `linear-gradient(135deg, ${getTypeColor(monster.type)}dd, ${getTypeColor(monster.type)})`,
                            borderRadius: '50%',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontSize: '52px',
                            border: '3px solid #333',
                            boxShadow: '0 4px 8px rgba(0,0,0,0.15)'
                          }}>
                            {monster.sprite}
                          </div>
                          <h3 style={{ margin: '10px 0', fontSize: '19px', fontWeight: 'bold' }}>{monster.name}</h3>
                          <div style={{
                            display: 'inline-block',
                            padding: '4px 12px',
                            background: getTypeColor(monster.type),
                            color: 'white',
                            borderRadius: '15px',
                            fontSize: '12px',
                            fontWeight: 'bold',
                            marginBottom: '10px'
                          }}>
                            {monster.type === 'fire' ? 'ğŸ”¥ã»ã®ãŠ' : monster.type === 'water' ? 'ğŸ’§ã¿ãš' : 'ğŸŒ¿ãã•'}
                          </div>
                          <p style={{ margin: '8px 0', fontSize: '12px', color: '#666' }}>
                            HP:{monster.baseHP} / æ”»:{monster.baseAtk} / é˜²:{monster.baseDef}
                          </p>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            );
          }

          // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¤ãƒ³ãƒˆãƒ­
          if (screen === 'story-intro') {
            return (
              <div style={{ 
                minHeight: '100vh', 
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                padding: '20px',
                fontFamily: 'Arial, sans-serif'
              }}>
                <div className="fade-in" style={{
                  background: 'white',
                  border: '4px solid #333',
                  borderRadius: '20px',
                  padding: '40px',
                  maxWidth: '600px',
                  textAlign: 'center'
                }}>
                  <h2 style={{ fontSize: '28px', marginBottom: '25px', color: '#667eea' }}>ã‚ˆã†ã“ãï¼</h2>
                  <p style={{ fontSize: '16px', lineHeight: '1.8', marginBottom: '15px' }}>
                    ãã¿ã¯{playerMonster.name}ã¨å…±ã«<br/>
                    ã“ã®ä¸–ç•Œã‚’å†’é™ºã™ã‚‹ã“ã¨ã«ãªã£ãŸã€‚
                  </p>
                  <p style={{ fontSize: '16px', lineHeight: '1.8', marginBottom: '15px' }}>
                    å„åœ°ã®ç”ºã‚’è¨ªã‚Œã€é“ã‚’é€²ã¿ã€<br/>
                    å¼·åŠ›ãªãƒ©ã‚¤ãƒãƒ«ãŸã¡ã«æŒ‘ã‚‚ã†ï¼
                  </p>
                  <p style={{ fontSize: '16px', lineHeight: '1.8', marginBottom: '30px' }}>
                    æœ€å¾Œã«ã¯ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ãŒå¾…ã£ã¦ã„ã‚‹ã€‚<br/>
                    é ‚ç‚¹ã‚’ç›®æŒ‡ã—ã¦ã€ãŒã‚“ã°ã‚Œï¼
                  </p>
                  <button
                    onClick={() => setScreen('town')}
                    style={{
                      background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                      color: 'white',
                      border: 'none',
                      padding: '15px 40px',
                      fontSize: '18px',
                      borderRadius: '25px',
                      cursor: 'pointer',
                      fontWeight: 'bold'
                    }}
                  >
                    å†’é™ºã‚’å§‹ã‚ã‚‹
                  </button>
                </div>
              </div>
            );
          }

          // ç”ºç”»é¢
          if (screen === 'town') {
            const currentTown = STORY_DATA.towns.find(t => t.id === currentLocation);
            const availableRoutes = STORY_DATA.routes.filter(r => r.from === currentLocation);
            const availableRivals = STORY_DATA.rivals.filter(r => r.location === currentLocation && !defeatedRivals.includes(r.id));
            
            return (
              <div style={{ 
                minHeight: '100vh', 
                background: 'linear-gradient(to bottom, #87CEEB, #E8F4F8)',
                padding: '20px',
                fontFamily: 'Arial, sans-serif'
              }}>
                <div style={{ maxWidth: '700px', margin: '0 auto' }}>
                  {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
                  <div style={{
                    background: 'white',
                    border: '3px solid #333',
                    borderRadius: '15px',
                    padding: '20px',
                    marginBottom: '20px',
                    boxShadow: '0 4px 10px rgba(0,0,0,0.1)'
                  }}>
                    <h2 style={{ textAlign: 'center', fontSize: '24px', marginBottom: '15px', color: '#667eea' }}>
                      ğŸ“ {currentTown.name}
                    </h2>
                    <div style={{ display: 'flex', justifyContent: 'space-around', fontSize: '16px' }}>
                      <div>ğŸ’° {money}å††</div>
                      <div>{playerMonster.name} Lv.{playerMonster.level}</div>
                      <div>HP: {playerMonster.currentHP}/{playerMonster.maxHP}</div>
                    </div>
                  </div>

                  {/* ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚»ãƒ³ã‚¿ãƒ¼ */}
                  <div style={{
                    background: 'white',
                    border: '3px solid #333',
                    borderRadius: '15px',
                    padding: '20px',
                    marginBottom: '15px'
                  }}>
                    <h3 style={{ marginBottom: '15px', fontSize: '18px' }}>ğŸ¥ ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚»ãƒ³ã‚¿ãƒ¼</h3>
                    <button
                      onClick={healAtCenter}
                      disabled={playerMonster.currentHP === playerMonster.maxHP && !playerMonster.status}
                      style={{
                        width: '100%',
                        background: playerMonster.currentHP === playerMonster.maxHP && !playerMonster.status ? '#ccc' : '#FF6B9D',
                        color: 'white',
                        border: 'none',
                        padding: '12px',
                        fontSize: '16px',
                        borderRadius: '10px',
                        cursor: playerMonster.currentHP === playerMonster.maxHP && !playerMonster.status ? 'not-allowed' : 'pointer',
                        fontWeight: 'bold'
                      }}
                    >
                      ç„¡æ–™ã§å…¨å›å¾©ã™ã‚‹
                    </button>
                  </div>

                  {/* ã‚·ãƒ§ãƒƒãƒ— */}
                  {currentTown.shop && (
                    <div style={{
                      background: 'white',
                      border: '3px solid #333',
                      borderRadius: '15px',
                      padding: '20px',
                      marginBottom: '15px'
                    }}>
                      <h3 style={{ marginBottom: '15px', fontSize: '18px' }}>ğŸª ã‚·ãƒ§ãƒƒãƒ—</h3>
                      <div style={{ display: 'grid', gap: '10px' }}>
                        {Object.entries(ITEMS).map(([key, item]) => (
                          <div key={key} style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            padding: '10px',
                            background: '#f5f5f5',
                            borderRadius: '8px'
                          }}>
                            <div>
                              <div style={{ fontWeight: 'bold' }}>{item.name} - {item.price}å††</div>
                              <div style={{ fontSize: '12px', color: '#666' }}>{item.description}</div>
                              <div style={{ fontSize: '12px', color: '#999' }}>æ‰€æŒ: {inventory[key] || 0}å€‹</div>
                            </div>
                            <button
                              onClick={() => buyItem(key)}
                              disabled={money < item.price}
                              style={{
                                background: money < item.price ? '#ccc' : '#4CAF50',
                                color: 'white',
                                border: 'none',
                                padding: '8px 15px',
                                borderRadius: '8px',
                                cursor: money < item.price ? 'not-allowed' : 'pointer',
                                fontWeight: 'bold',
                                fontSize: '14px'
                              }}
                            >
                              è³¼å…¥
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* ãƒ©ã‚¤ãƒãƒ«æˆ¦ */}
                  {availableRivals.length > 0 && (
                    <div style={{
                      background: 'linear-gradient(135deg, #FFA07A, #FF6347)',
                      border: '3px solid #333',
                      borderRadius: '15px',
                      padding: '20px',
                      marginBottom: '15px',
                      color: 'white'
                    }}>
                      <h3 style={{ marginBottom: '15px', fontSize: '18px' }}>âš”ï¸ ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼æˆ¦</h3>
                      {availableRivals.map(rival => (
                        <button
                          key={rival.id}
                          onClick={() => startRivalBattle(rival.id)}
                          style={{
                            width: '100%',
                            background: 'rgba(255,255,255,0.3)',
                            color: 'white',
                            border: '2px solid white',
                            padding: '15px',
                            fontSize: '16px',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontWeight: 'bold',
                            marginBottom: '10px'
                          }}
                        >
                          <div style={{ fontSize: '20px', marginBottom: '5px' }}>{rival.sprite}</div>
                          {rival.name} ã«æŒ‘æˆ¦ï¼<br/>
                          <span style={{ fontSize: '13px' }}>è³é‡‘: {rival.reward}å††</span>
                        </button>
                      ))}
                    </div>
                  )}

                  {/* é“è·¯ */}
                  {availableRoutes.length > 0 && (
                    <div style={{
                      background: 'white',
                      border: '3px solid #333',
                      borderRadius: '15px',
                      padding: '20px',
                      marginBottom: '15px'
                    }}>
                      <h3 style={{ marginBottom: '15px', fontSize: '18px' }}>ğŸ›£ï¸ å†’é™ºã™ã‚‹</h3>
                      {availableRoutes.map(route => (
                        <button
                          key={route.id}
                          onClick={() => startWildBattle(route.id)}
                          style={{
                            width: '100%',
                            background: 'linear-gradient(135deg, #78C850, #5CA935)',
                            color: 'white',
                            border: 'none',
                            padding: '15px',
                            fontSize: '16px',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            fontWeight: 'bold',
                            marginBottom: '10px',
                            boxShadow: '0 4px 8px rgba(0,0,0,0.15)'
                          }}
                        >
                          {route.name} ã¸é€²ã‚€<br/>
                          <span style={{ fontSize: '13px', opacity: 0.9 }}>
                            (Lv.{route.minLevel}ã€œ{route.maxLevel} ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼)
                          </span>
                        </button>
                      ))}
                    </div>
                  )}

                  {/* ç§»å‹• */}
                  <div style={{
                    background: 'white',
                    border: '3px solid #333',
                    borderRadius: '15px',
                    padding: '20px',
                    marginBottom: '15px'
                  }}>
                    <h3 style={{ marginBottom: '15px', fontSize: '18px' }}>ğŸš¶ ç”ºã¸ç§»å‹•</h3>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                      {STORY_DATA.towns.filter(t => t.id !== currentLocation).map(town => {
                        const canVisit = 
                          (currentLocation === 'start' && town.id === 'forest' && defeatedRivals.includes('rival1')) ||
                          (currentLocation === 'forest' && (town.id === 'start' || (town.id === 'mountain' && defeatedRivals.includes('rival2')))) ||
                          (currentLocation === 'mountain' && (town.id === 'forest' || (town.id === 'final' && defeatedRivals.includes('rival3')))) ||
                          (currentLocation === 'final' && town.id === 'mountain');
                        
                        return (
                          <button
                            key={town.id}
                            onClick={() => moveToLocation(town.id)}
                            disabled={!canVisit}
                            style={{
                              background: canVisit ? '#4A90E2' : '#ccc',
                              color: 'white',
                              border: 'none',
                              padding: '12px',
                              fontSize: '14px',
                              borderRadius: '8px',
                              cursor: canVisit ? 'pointer' : 'not-allowed',
                              fontWeight: 'bold'
                            }}
                          >
                            {town.name}
                          </button>
                        );
                      })}
                    </div>
                  </div>

                  {/* ãƒªã‚»ãƒƒãƒˆ */}
                  <button
                    onClick={resetGame}
                    style={{
                      width: '100%',
                      background: '#999',
                      color: 'white',
                      border: 'none',
                      padding: '12px',
                      fontSize: '14px',
                      borderRadius: '10px',
                      cursor: 'pointer'
                    }}
                  >
                    ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                  </button>
                </div>
              </div>
            );
          }

          // ãƒãƒˆãƒ«ç”»é¢
          if (screen === 'battle') {
            return (
              <div style={{ 
                minHeight: '100vh', 
                background: 'linear-gradient(to bottom, #FFE5B4, #FFD700)',
                padding: '20px',
                fontFamily: 'Arial, sans-serif'
              }}>
                <div style={{ maxWidth: '800px', margin: '0 auto' }}>
                  {/* æ•µãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ */}
                  <div style={{ 
                    display: 'flex', 
                    justifyContent: 'flex-end',
                    marginBottom: '40px',
                    paddingRight: '30px'
                  }}>
                    <div>
                      <div style={{
                        background: 'white',
                        border: '3px solid #333',
                        borderRadius: '15px',
                        padding: '15px',
                        marginBottom: '15px',
                        minWidth: '280px',
                        boxShadow: '0 4px 10px rgba(0,0,0,0.15)'
                      }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px', alignItems: 'center' }}>
                          <span style={{ fontWeight: 'bold', fontSize: '18px' }}>{enemyMonster.name} {getStatusIcon(enemyMonster.status)}</span>
                          <span style={{ fontSize: '16px' }}>Lv.{enemyMonster.level}</span>
                        </div>
                        <div style={{ marginBottom: '5px', display: 'flex', justifyContent: 'space-between', fontSize: '14px' }}>
                          <span>HP:</span>
                          <span>{enemyMonster.currentHP} / {enemyMonster.maxHP}</span>
                        </div>
                        <div style={{ 
                          width: '100%', 
                          height: '24px', 
                          background: '#e0e0e0', 
                          borderRadius: '12px',
                          overflow: 'hidden',
                          border: '2px solid #999'
                        }}>
                          <div style={{ 
                            width: `${(enemyMonster.currentHP / enemyMonster.maxHP) * 100}%`,
                            height: '100%',
                            background: getHPBarColor(enemyMonster.currentHP, enemyMonster.maxHP),
                            transition: 'width 0.5s ease-out'
                          }} />
                        </div>
                      </div>
                      <div style={{
                        width: '180px',
                        height: '180px',
                        background: damageFlash === 'enemy' ? 'radial-gradient(circle, #ff0000 0%, #ff000080 100%)' : `linear-gradient(135deg, ${getTypeColor(enemyMonster.type)}dd, ${getTypeColor(enemyMonster.type)})`,
                        borderRadius: '50%',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '120px',
                        transition: 'all 0.3s',
                        margin: '0 auto',
                        border: '4px solid #333',
                        boxShadow: damageFlash === 'enemy' ? '0 0 30px rgba(255,0,0,0.8)' : '0 8px 16px rgba(0,0,0,0.2)'
                      }}>
                        {enemyMonster.sprite}
                      </div>
                    </div>
                  </div>

                  {/* å‘³æ–¹ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ */}
                  <div style={{ 
                    display: 'flex', 
                    justifyContent: 'flex-start',
                    marginBottom: '30px',
                    paddingLeft: '30px'
                  }}>
                    <div>
                      <div style={{
                        width: '180px',
                        height: '180px',
                        background: damageFlash === 'player' ? 'radial-gradient(circle, #ff0000 0%, #ff000080 100%)' : `linear-gradient(135deg, ${getTypeColor(playerMonster.type)}dd, ${getTypeColor(playerMonster.type)})`,
                        borderRadius: '50%',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '120px',
                        transition: 'all 0.3s',
                        margin: '0 auto 15px',
                        border: '4px solid #333',
                        boxShadow: damageFlash === 'player' ? '0 0 30px rgba(255,0,0,0.8)' : '0 8px 16px rgba(0,0,0,0.2)'
                      }}>
                        {playerMonster.sprite}
                      </div>
                      <div style={{
                        background: 'white',
                        border: '3px solid #333',
                        borderRadius: '15px',
                        padding: '15px',
                        minWidth: '280px',
                        boxShadow: '0 4px 10px rgba(0,0,0,0.15)'
                      }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px', alignItems: 'center' }}>
                          <span style={{ fontWeight: 'bold', fontSize: '18px' }}>{playerMonster.name} {getStatusIcon(playerMonster.status)}</span>
                          <span style={{ fontSize: '16px' }}>Lv.{playerMonster.level}</span>
                        </div>
                        <div style={{ marginBottom: '5px', display: 'flex', justifyContent: 'space-between', fontSize: '14px' }}>
                          <span>HP:</span>
                          <span>{playerMonster.currentHP} / {playerMonster.maxHP}</span>
                        </div>
                        <div style={{ 
                          width: '100%', 
                          height: '24px', 
                          background: '#e0e0e0', 
                          borderRadius: '12px',
                          overflow: 'hidden',
                          marginBottom: '10px',
                          border: '2px solid #999'
                        }}>
                          <div style={{ 
                            width: `${(playerMonster.currentHP / playerMonster.maxHP) * 100}%`,
                            height: '100%',
                            background: getHPBarColor(playerMonster.currentHP, playerMonster.maxHP),
                            transition: 'width 0.5s ease-out'
                          }} />
                        </div>
                        <div style={{ marginBottom: '5px', display: 'flex', justifyContent: 'space-between', fontSize: '12px' }}>
                          <span>EXP:</span>
                          <span>{playerMonster.exp} / {playerMonster.expToNext}</span>
                        </div>
                        <div style={{ 
                          width: '100%', 
                          height: '14px', 
                          background: '#e0e0e0', 
                          borderRadius: '7px',
                          overflow: 'hidden',
                          border: '2px solid #999'
                        }}>
                          <div style={{ 
                            width: `${(playerMonster.exp / playerMonster.expToNext) * 100}%`,
                            height: '100%',
                            background: '#4A90E2',
                            transition: 'width 0.5s ease-out'
                          }} />
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* ãƒãƒˆãƒ«ãƒ­ã‚° */}
                  <div style={{
                    background: 'white',
                    border: '3px solid #333',
                    borderRadius: '15px',
                    padding: '20px',
                    marginBottom: '20px',
                    minHeight: '130px',
                    maxHeight: '150px',
                    overflowY: 'auto',
                    fontSize: '15px',
                    lineHeight: '1.8',
                    boxShadow: '0 4px 10px rgba(0,0,0,0.1)'
                  }}>
                    {battleLog.slice(-5).map((log, idx) => (
                      <p key={idx} style={{ 
                        margin: '6px 0',
                        fontWeight: log.includes('åŠ¹æœã¯') || log.includes('ãƒ€ãƒ¡ãƒ¼ã‚¸') ? 'bold' : 'normal',
                        color: log.includes('åŠ¹æœã¯æŠœç¾¤') ? '#E74C3C' : log.includes('ã„ã¾ã²ã¨ã¤') ? '#95A5A6' : '#333'
                      }}>{log}</p>
                    ))}
                  </div>

                  {/* ã‚³ãƒãƒ³ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */}
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: '1fr 1fr',
                    gap: '15px',
                    marginBottom: '15px'
                  }}>
                    {playerMonster.moves.map((move, idx) => {
                      const moveTypeColor = move.type === 'fire' ? '#F08030' : 
                                           move.type === 'water' ? '#6890F0' : 
                                           move.type === 'grass' ? '#78C850' : '#A8A878';
                      return (
                        <button
                          key={idx}
                          onClick={() => playerAttack(move)}
                          disabled={!isPlayerTurn || isAnimating}
                          style={{
                            background: !isPlayerTurn || isAnimating ? '#ccc' : 
                                       `linear-gradient(135deg, ${moveTypeColor} 0%, ${moveTypeColor}dd 100%)`,
                            color: 'white',
                            border: '3px solid #333',
                            padding: '18px',
                            fontSize: '15px',
                            borderRadius: '12px',
                            cursor: !isPlayerTurn || isAnimating ? 'not-allowed' : 'pointer',
                            fontWeight: 'bold',
                            textAlign: 'left',
                            boxShadow: !isPlayerTurn || isAnimating ? 'none' : '0 4px 8px rgba(0,0,0,0.2)',
                            transition: 'all 0.2s'
                          }}
                        >
                          <div style={{ fontSize: '17px', marginBottom: '6px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span>{move.type === 'fire' ? 'ğŸ”¥' : move.type === 'water' ? 'ğŸ’§' : move.type === 'grass' ? 'ğŸŒ¿' : 'â­'}</span>
                            <span>{move.name}</span>
                          </div>
                          <div style={{ fontSize: '13px', opacity: 0.9 }}>
                            å¨åŠ›: {move.power || 'âˆ’'}
                          </div>
                        </button>
                      );
                    })}
                  </div>

                  {/* ã©ã†ããƒ»ã«ã’ã‚‹ */}
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: '1fr 1fr',
                    gap: '15px'
                  }}>
                    <button
                      onClick={() => setScreen('battle-item')}
                      disabled={!isPlayerTurn || isAnimating}
                      style={{
                        background: !isPlayerTurn || isAnimating ? '#ccc' : '#FFA726',
                        color: 'white',
                        border: '3px solid #333',
                        padding: '15px',
                        fontSize: '16px',
                        borderRadius: '12px',
                        cursor: !isPlayerTurn || isAnimating ? 'not-allowed' : 'pointer',
                        fontWeight: 'bold'
                      }}
                    >
                      ğŸ’¼ ã©ã†ã
                    </button>
                    <button
                      onClick={runAway}
                      disabled={!isPlayerTurn || isAnimating || battleType !== 'wild'}
                      style={{
                        background: !isPlayerTurn || isAnimating || battleType !== 'wild' ? '#ccc' : '#EF5350',
                        color: 'white',
                        border: '3px solid #333',
                        padding: '15px',
                        fontSize: '16px',
                        borderRadius: '12px',
                        cursor: !isPlayerTurn || isAnimating || battleType !== 'wild' ? 'not-allowed' : 'pointer',
                        fontWeight: 'bold'
                      }}
                    >
                      ğŸƒ ã«ã’ã‚‹
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          // ãƒãƒˆãƒ«ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ç”»é¢
          if (screen === 'battle-item') {
            return (
              <div style={{ 
                minHeight: '100vh', 
                background: 'linear-gradient(to bottom, #FFE5B4, #FFD700)',
                padding: '20px',
                fontFamily: 'Arial, sans-serif'
              }}>
                <div style={{ maxWidth: '600px', margin: '0 auto' }}>
                  <div style={{
                    background: 'white',
                    border: '3px solid #333',
                    borderRadius: '15px',
                    padding: '25px',
                    boxShadow: '0 4px 10px rgba(0,0,0,0.15)'
                  }}>
                    <h2 style={{ marginBottom: '20px', fontSize: '22px', textAlign: 'center' }}>ğŸ’¼ ã©ã†ãã‚’ä½¿ã†</h2>
                    <div style={{ display: 'grid', gap: '12px', marginBottom: '20px' }}>
                      {Object.entries(ITEMS).filter(([key]) => inventory[key] > 0).map(([key, item]) => (
                        <button
                          key={key}
                          onClick={() => {
                            useItem(key);
                            setScreen('battle');
                          }}
                          style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            padding: '15px',
                            background: '#f5f5f5',
                            border: '2px solid #333',
                            borderRadius: '10px',
                            cursor: 'pointer',
                            textAlign: 'left',
                            fontSize: '15px'
                          }}
                        >
                          <div>
                            <div style={{ fontWeight: 'bold', marginBottom: '4px' }}>{item.name}</div>
                            <div style={{ fontSize: '13px', color: '#666' }}>{item.description}</div>
                          </div>
                          <div style={{ fontWeight: 'bold', fontSize: '16px' }}>Ã—{inventory[key]}</div>
                        </button>
                      ))}
                      {Object.keys(inventory).filter(key => inventory[key] > 0).length === 0 && (
                        <p style={{ textAlign: 'center', color: '#999', padding: '20px' }}>
                          ä½¿ãˆã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“
                        </p>
                      )}
                    </div>
                    <button
                      onClick={() => setScreen('battle')}
                      style={{
                        width: '100%',
                        background: '#999',
                        color: 'white',
                        border: 'none',
                        padding: '12px',
                        fontSize: '16px',
                        borderRadius: '10px',
                        cursor: 'pointer',
                        fontWeight: 'bold'
                      }}
                    >
                      ã‚‚ã©ã‚‹
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          // é€²åŒ–ç”»é¢
          if (showEvolution) {
            return (
              <div style={{ 
                minHeight: '100vh', 
                background: 'linear-gradient(to bottom, #1a1a2e, #16213e)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontFamily: 'Arial, sans-serif',
                color: 'white'
              }}>
                <div style={{ textAlign: 'center' }} className="fade-in">
                  <h1 style={{ fontSize: '40px', marginBottom: '40px', animation: 'bounce 1s infinite' }}>
                    âœ¨ é€²åŒ–ä¸­... âœ¨
                  </h1>
                  <p style={{ fontSize: '28px', marginBottom: '20px' }}>
                    {evolutionData.from}
                  </p>
                  <p style={{ fontSize: '40px', marginBottom: '20px' }}>â†“</p>
                  <p style={{ fontSize: '32px', fontWeight: 'bold', color: '#FFD700' }}>
                    {evolutionData.to}
                  </p>
                </div>
              </div>
            );
          }

          // ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
          if (screen === 'ending') {
            return (
              <div style={{ 
                minHeight: '100vh', 
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                padding: '20px',
                fontFamily: 'Arial, sans-serif'
              }}>
                <div className="fade-in" style={{
                  background: 'white',
                  border: '4px solid #333',
                  borderRadius: '20px',
                  padding: '50px 40px',
                  maxWidth: '600px',
                  textAlign: 'center',
                  boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
                }}>
                  <h1 style={{ fontSize: '42px', marginBottom: '20px', color: '#FFD700' }}>ğŸ† ãŠã‚ã§ã¨ã†ï¼ ğŸ†</h1>
                  <p style={{ fontSize: '20px', marginBottom: '15px', lineHeight: '1.8' }}>
                    ãã¿ã¯å…¨ã¦ã®ãƒ©ã‚¤ãƒãƒ«ã‚’å€’ã—ã€<br/>
                    ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ã¨ãªã£ãŸï¼
                  </p>
                  <p style={{ fontSize: '18px', marginBottom: '15px', color: '#666' }}>
                    {playerMonster.name} Lv.{playerMonster.level}<br/>
                    ç²å¾—è³é‡‘: {money}å††
                  </p>
                  <p style={{ fontSize: '16px', marginBottom: '35px', lineHeight: '1.8', color: '#666' }}>
                    ç´ æ™´ã‚‰ã—ã„å†’é™ºã ã£ãŸï¼<br/>
                    ã‚ã‚ŠãŒã¨ã†ã€ãã—ã¦ã¾ãŸä¼šãŠã†ï¼
                  </p>
                  <button
                    onClick={resetGame}
                    style={{
                      background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                      color: 'white',
                      border: 'none',
                      padding: '18px 50px',
                      fontSize: '20px',
                      borderRadius: '30px',
                      cursor: 'pointer',
                      fontWeight: 'bold',
                      boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                    }}
                  >
                    æœ€åˆã‹ã‚‰éŠã¶
                  </button>
                </div>
              </div>
            );
          }

          // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
          if (screen === 'gameover') {
            return (
              <div style={{ 
                minHeight: '100vh', 
                background: 'linear-gradient(to bottom, #2c2c2c, #1a1a1a)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontFamily: 'Arial, sans-serif',
                padding: '20px'
              }}>
                <div className="fade-in" style={{ 
                  background: 'white', 
                  border: '4px solid #333',
                  borderRadius: '20px',
                  padding: '50px 40px',
                  textAlign: 'center',
                  maxWidth: '500px',
                  boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
                }}>
                  <h1 style={{ fontSize: '38px', margin: '0 0 25px 0', color: '#F85030' }}>
                    GAME OVER
                  </h1>
                  <p style={{ fontSize: '18px', marginBottom: '15px' }}>
                    {playerMonster.name}ã¯åŠ›å°½ããŸ...
                  </p>
                  <p style={{ fontSize: '16px', marginBottom: '35px', color: '#666' }}>
                    æ‰€æŒé‡‘: {money}å††
                  </p>
                  <button
                    onClick={() => {
                      healAtCenter();
                      setScreen('town');
                    }}
                    style={{
                      width: '100%',
                      background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                      color: 'white',
                      border: 'none',
                      padding: '15px 40px',
                      fontSize: '18px',
                      borderRadius: '25px',
                      cursor: 'pointer',
                      fontWeight: 'bold',
                      marginBottom: '15px'
                    }}
                  >
                    ç”ºã«æˆ»ã‚‹
                  </button>
                  <button
                    onClick={resetGame}
                    style={{
                      width: '100%',
                      background: '#999',
                      color: 'white',
                      border: 'none',
                      padding: '12px',
                      fontSize: '16px',
                      borderRadius: '20px',
                      cursor: 'pointer'
                    }}
                  >
                    æœ€åˆã‹ã‚‰
                  </button>
                </div>
              </div>
            );
          }

          return null;
        };

        ReactDOM.render(<MonsterRPG />, document.getElementById('root'));
    </script>
</body>
</html>
